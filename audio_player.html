<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FH's Web MP3 Player</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --accent: #d946ef; /* Magenta/Purple */
            --accent-glow: rgba(217, 70, 239, 0.4);
            --bg-main: #09090b;
            --glass-panel: rgba(24, 24, 27, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #fafafa;
            --text-dim: #a1a1aa;
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-user-select: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #1a103c, #000000);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; padding: 25px;
            backdrop-filter: blur(20px);
            z-index: 2;
        }

        .logo { 
            font-weight: 800; font-size: 20px; margin-bottom: 30px; 
            background: linear-gradient(45deg, #fff, var(--accent)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .nav-section { margin-bottom: 30px; }
        .nav-label { font-size: 10px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; }
        
        .nav-item {
            padding: 10px 14px; margin-bottom: 4px; border-radius: 10px;
            cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-dim);
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; transform: translateX(4px); }
        .nav-item.active { background: rgba(217, 70, 239, 0.15); color: var(--accent); }
        .nav-item i { margin-right: 10px; font-style: normal; }

        .trash-btn { opacity: 0; color: #ef4444; transition: opacity 0.2s; font-size: 14px; padding: 4px; }
        .nav-item:hover .trash-btn { opacity: 1; }

        /* --- Main Content --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .top-bar { padding: 20px 30px; display: flex; align-items: center; justify-content: space-between; }
        
        .search-box {
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            padding: 12px 20px; border-radius: 50px; width: 350px;
            color: white; font-size: 14px; transition: 0.2s;
            backdrop-filter: blur(10px);
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        .view-options { position: relative; }
        .view-btn { background: none; border: 1px solid var(--glass-border); color: var(--text-dim); font-size: 16px; padding: 10px; border-radius: 10px; cursor: pointer; }
        .view-menu { display: none; position: absolute; top: 100%; right: 0; background: #18181b; border: 1px solid var(--glass-border); padding: 6px; border-radius: 12px; z-index: 100; min-width: 120px; }
        .view-item { padding: 10px 12px; font-size: 13px; color: var(--text-dim); cursor: pointer; border-radius: 8px; }
        .view-item:hover { background: var(--accent); color: white; }
        .view-item.active { color: var(--accent); }

        .view-area { flex: 1; overflow-y: auto; padding: 0 30px 120px 30px; scroll-behavior: smooth; }
        
        /* Views */
        .page-view { display: none; animation: fadeIn 0.3s; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Settings Page */
        .settings-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 25px; margin-bottom: 20px;
            max-width: 600px;
        }
        .settings-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: 0.2s;
            display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center;
        }
        .settings-btn:hover { background: var(--accent); border-color: var(--accent); }
        .path-display { 
            font-family: monospace; color: var(--text-dim); font-size: 12px; 
            margin-top: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px;
        }

        /* Track List */
        .track-row {
            display: grid;
            grid-template-columns: 40px 1fr 80px 80px;
            align-items: center;
            padding: 12px 15px;
            border-radius: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            transition: 0.1s;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 14px;
        }

        .track-row:hover { background: rgba(255,255,255,0.03); color: white; }
        .track-row.selected { background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; }
        .track-row.playing { color: var(--accent); font-weight: 600; }
        
        /* --- Player Bar --- */
        .player-float {
            position: absolute; bottom: 25px; left: 30px; right: 30px;
            height: 85px;
            background: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; z-index: 50;
        }
        
        .controls-center { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .btn-group { display: flex; align-items: center; gap: 20px; }
        
        .btn-icon { background: none; border: none; color: var(--text-dim); cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-icon:hover { color: white; transform: scale(1.1); }
        .btn-icon.active { color: var(--accent); } /* Active state for Shuffle */
        
        .play-fab {
            width: 80px; height: 45px;
            background: white; color: black; border-radius: 50px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .play-fab:hover { transform: scale(1.05); }

        .progress-bar { width: 100%; max-width: 450px; display: flex; align-items: center; gap: 12px; font-size: 11px; color: var(--text-dim); }
        input[type=range] {
            --value-percent: 0%;
            -webkit-appearance: none;
            background: transparent;
            flex: 1;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: linear-gradient(to right, var(--accent) var(--value-percent), rgba(255,255,255,0.1) var(--value-percent));
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            background: white;
            border-radius: 50%;
            margin-top: -4px;
            opacity: 0;
            transition: 0.2s;
        }
        .player-float:hover input[type=range]::-webkit-slider-thumb { opacity: 1; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(5px); }
        .modal { background: #18181b; padding: 30px; border-radius: 20px; width: 380px; border: 1px solid var(--glass-border); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 15px; }

        .ctx-menu { position: fixed; background: #18181b; border: 1px solid var(--glass-border); padding: 6px; border-radius: 12px; display: none; z-index: 100; min-width: 180px; }
        .ctx-item { padding: 10px 12px; font-size: 13px; color: var(--text-dim); cursor: pointer; border-radius: 8px; }
        .ctx-item:hover { background: var(--accent); color: white; }
        .ctx-divider { height: 1px; background: var(--glass-border); margin: 4px 6px; }

    </style>
</head>
<body onclick="handleGlobalClick(event)">

<aside class="sidebar">
    <div class="logo">FH's Web MP3 Player</div>

    <div class="nav-section">
        <div class="nav-label">Main</div>
        <div class="nav-item active" id="nav-library" onclick="switchView('library')">
            <span>Library</span>
        </div>
        <div class="nav-item" id="nav-settings" onclick="switchView('settings')">
            <span>Settings</span>
        </div>
        <div class="nav-item" id="nav-guide" onclick="switchView('guide')">
            <span>Guide</span>
        </div>
    </div>

    <div class="nav-section">
        <div class="nav-label" style="display:flex; justify-content:space-between">
            Playlists 
            <span style="cursor:pointer; font-size:16px" onclick="openModal('new-p-modal')">+</span>
        </div>
        <div id="playlist-list"></div>
    </div>
</aside>

<main class="main">
    <div class="top-bar">
        <div style="display: flex; align-items: center; gap: 20px;">
            <input type="text" class="search-box" id="search" placeholder="Search tracks..." oninput="render()">
            <div class="view-options">
                <button class="view-btn" onclick="toggleSortMenu()">☰</button>
                            <div class="view-menu" id="view-menu">
                                <div class="view-item active" data-mode="alphabetical" onclick="setSortMode('alphabetical')">Alphabetical</div>
                                <div class="view-item" data-mode="length" onclick="setSortMode('length')">Length</div>
                                <div class="view-item" data-mode="format" onclick="setSortMode('format')">File Format</div>
                                <div class="ctx-divider"></div>
                                <div class="view-item" onclick="toggleSortOrder()">Reverse</div>
                            </div>            </div>
        </div>
        <div style="font-size:12px; color:var(--text-dim)" id="track-count"></div>
    </div>

    <div class="view-area">
        
        <div id="view-library" class="page-view active">
            <div id="restore-banner" style="display:none; background:rgba(217,70,239,0.1); border:1px solid var(--accent); padding:15px; border-radius:12px; margin-bottom:20px; align-items:center; justify-content:space-between">
                <span style="color:var(--accent)">Previous session found.</span>
                <button onclick="restoreSession()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600">Restore</button>
            </div>
            <div id="track-list">
                <div style="text-align:center; padding: 100px; opacity: 0.5;">
                    <h2>No Music Loaded</h2>
                    <p>Go to Settings to select your music folder.</p>
                </div>
            </div>
        </div>

        <div id="view-settings" class="page-view">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            
            <div class="settings-card">
                <h3>Music Source</h3>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">Select the folder containing your audio files (.mp3, .ogg, .wav).</p>
                <button class="settings-btn" onclick="pickFolder('music')">Select Music Folder</button>
                <div class="path-display" id="path-music">No folder selected</div>
            </div>

            <div class="settings-card">
                <h3>Playlist Storage</h3>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">Select where playlist files (.json) should be saved.</p>
                <button class="settings-btn" onclick="pickFolder('playlist')">Select Playlist Folder</button>
                <div class="path-display" id="path-playlist">No folder selected</div>
            </div>

            <div class="settings-card">
                <h3>Shortcuts</h3>
                <div style="font-size:13px; color:var(--text-dim); display:grid; grid-template-columns: 100px 1fr; gap:10px">
                    <span>Space</span> <span style="color:white">Play / Pause</span>
                    <span>Arrows ⬅ ➡</span> <span style="color:white">Skip 5 Seconds</span>
                    <span>Cmd + Click</span> <span style="color:white">Multi-select tracks</span>
                </div>
            </div>
        </div>

        <div id="view-guide" class="page-view">
            <h2>FH's Web MP3 Player Guide</h2>
            <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">Welcome to FH's Web MP3 Player! This guide will help you get started and make the most of your local music playback experience.</p>

            <div class="settings-card">
                <h3>1. Getting Started: Setting Up Your Music & Playlists</h3>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">FH's Web MP3 Player works directly with your local files without needing to upload anything.</p>
                
                <h4>Select Music Folder:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Go to the <b>Settings</b> view (click "Settings" in the sidebar).</li>
                    <li>Under "Music Source," click the "Select Music Folder" button.</li>
                    <li>A file picker will appear. Navigate to and select the main folder where your music files (MP3, OGG, WAV) are stored. The player will scan this folder and its subfolders for audio files.</li>
                    <li>You'll see a progress indicator as the player analyzes your tracks and extracts details like duration.</li>
                </ul>

                <h4>Select Playlist Folder:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>In the <b>Settings</b> view, under "Playlist Storage," click the "Select Playlist Folder" button.</li>
                    <li>Choose a folder where you want your playlists (.json files) to be saved. This allows you to manage your playlists locally.</li>
                </ul>

                <h4>Session Restoration:</h4>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">The player remembers the folders you selected in previous sessions. If you return, a "Previous session found." banner will appear. Click "Restore" to quickly load your music and playlists without re-selecting folders.</p>
            </div>

            <div class="settings-card">
                <h3>2. Playing Music</h3>
                <h4>Browse Library:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Go to the <b>Library</b> view (click "Library" in the sidebar).</li>
                    <li>You'll see a list of all detected tracks, displaying the track number, song name, artist, file type, and duration.</li>
                </ul>

                <h4>Search for Tracks:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Use the "Search tracks..." input in the top bar to filter your library by song name or artist.</li>
                </ul>

                <h4>Play a Track:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li><b>Double-click</b> on any track in the list to start playback.</li>
                    <li>Alternatively, <b>single-click</b> a track to select it, then <b>right-click</b> (or long-press on touch devices) to open the context menu and choose "Play Selection".</li>
                </ul>

                <h4>Now Playing:</h4>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px">The bottom player bar will show the currently playing song's name and artist.</p>
            </div>

            <div class="settings-card">
                <h3>3. Playlist Management</h3>
                <h4>Create a New Playlist:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>In the sidebar, next to "Playlists," click the "+" button.</li>
                    <li>Enter a name for your new playlist in the pop-up, then click "Create."</li>
                </ul>

                <h4>Add Tracks to a Playlist:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li><b>Select</b> one or more tracks in your Library or another playlist.</li>
                    <li>To select multiple tracks, hold `Ctrl` (Windows/Linux) or `Cmd` (Mac) and click on desired tracks.</li>
                    <li>To select a range, click the first track, then hold `Shift` and click the last track.</li>
                    <li><b>Right-click</b> on any selected track to open the context menu.</li>
                    <li>Choose "Add to Playlist..."</li>
                    <li>Select the target playlist from the list in the pop-up.</li>
                </ul>

                <h4>View a Playlist:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Click on any playlist name in the sidebar to view its tracks.</li>
                </ul>

                <h4>Delete a Playlist:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Hover over a playlist name in the sidebar. A "Delete" button will appear.</li>
                    <li>Click "Delete" and confirm to remove the playlist. This will only delete the playlist file, not your music files.</li>
                </ul>
            </div>

            <div class="settings-card">
                <h3>4. Sorting and Shuffling</h3>
                <h4>Sort Tracks:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Click the "☰" (menu) button next to the search bar in the top section.</li>
                    <li>Choose your desired sorting method: "Alphabetical," "Length," or "File Format."</li>
                    <li>Click "Reverse" in the same menu to toggle between ascending and descending order for the current sort mode.</li>
                </ul>

                <h4>Shuffle Playback:</h4>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li>Click the "Shuffle" button in the player controls (bottom bar) to toggle shuffle mode on or off. When active, it will play songs from your current queue in a random order.</li>
                </ul>
            </div>

            <div class="settings-card">
                <h3>5. Player Controls (Bottom Bar)</h3>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li><b>Shuffle:</b> Toggles random playback.</li>
                    <li><b>Prev:</b> Jumps to the previous track in the queue.</li>
                    <li><b>Play / Pause:</b> Starts or pauses the current track.</li>
                    <li><b>Next:</b> Jumps to the next track in the queue.</li>
                    <li><b>Seek Bar:</b> Drag the slider to jump to any point in the current track.</li>
                    <li><b>Volume:</b> Drag the slider to adjust the playback volume.</li>
                </ul>
            </div>

            <div class="settings-card">
                <h3>6. Keyboard Shortcuts</h3>
                <ul style="font-size:13px; color:var(--text-dim); margin-bottom:15px; padding-left: 20px;">
                    <li><b>Spacebar:</b> Play / Pause</li>
                    <li><b>Arrow Right (➡):</b> Skip forward 5 seconds</li>
                    <li><b>Arrow Left (⬅):</b> Skip backward 5 seconds</li>
                    <li><b>Cmd/Ctrl + Click:</b> Multi-select tracks</li>
                    <li><b>Shift + Click:</b> Select a range of tracks</li>
                </ul>
            </div>

            <p style="font-size:13px; color:var(--text-dim); margin-top:20px;">Enjoy your music!</p>
        </div>

    </div>

    <div class="player-float">
        <div style="width: 250px;">
            <div id="np-title" style="font-weight:600; color:white; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis"></div>
            <div id="np-artist" style="font-size:12px; color:var(--text-dim)"></div>
        </div>

        <div class="controls-center">
            <div class="btn-group">
                <button class="btn-icon" id="btn-shuffle" onclick="toggleShuffle()" title="Shuffle">Shuffle</button>
                <button class="btn-icon" onclick="prev()">Prev</button>
                <div class="play-fab" onclick="togglePlay()" id="play-icon">Play</div>
                <button class="btn-icon" onclick="next()">Next</button>
                <button class="btn-icon" style="opacity:0; cursor:default">Repeat</button> </div>
            <div class="progress-bar">
                <span id="t-cur">0:00</span>
                <input type="range" id="seek" value="0" step="0.1">
                <span id="t-dur">0:00</span>
            </div>
        </div>

        <div style="width: 250px; display:flex; justify-content:flex-end; align-items:center; gap:10px">
            <span>Volume</span>
            <input type="range" id="vol" max="1" step="0.05" value="0.8" style="width:80px">
        </div>
    </div>
</main>

<div class="ctx-menu" id="ctx-menu">
    <div class="ctx-item" onclick="playSelected()">Play Selection</div>
    <div class="ctx-item" onclick="openAddToModal()">Add to Playlist...</div>
</div>

<div class="modal-overlay" id="new-p-modal">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>New Playlist</h3>
        <input type="text" id="new-p-name" class="search-box" placeholder="Name" style="width:100%; margin:0">
        <button class="modal-btn" onclick="createPlaylist()">Create</button>
        <button class="modal-btn" style="background:#27272a; margin-top:10px" onclick="closeModals()">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="add-to-modal">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>Add to Playlist</h3>
        <div id="target-list" style="max-height: 200px; overflow-y:auto; margin:15px 0;"></div>
        <button class="modal-btn" style="background:#27272a" onclick="closeModals()">Cancel</button>
    </div>
</div>

<script>
    // --- State ---
    let library = [];       // All tracks
    let activeQueue = [];   // Currently playing queue (visible)
    let playQueue = [];     // Internal queue logic (handles shuffle)
    let playlists = {};
    let selectedIds = new Set();
    
    let musicHandle = null;
    let playlistHandle = null;
    
    let currentTrackId = null; 
    let isShuffled = false;
    let currentView = 'library'; // 'library', 'settings', or playlistName
    let sortMode = 'alphabetical'; // 'alphabetical', 'length', 'format'
    let sortOrder = 'asc'; // 'asc', 'desc'
    
    const audio = new Audio();

    // --- Init ---
    window.onload = async () => {
        // Load handles from DB
        const mh = await getDB('musicHandle');
        const ph = await getDB('playlistHandle');
        
        if (mh) {
            musicHandle = mh;
            document.getElementById('restore-banner').style.display = 'flex';
            document.getElementById('path-music').innerText = "Stored from previous session";
        }
        if (ph) {
            playlistHandle = ph;
            document.getElementById('path-playlist').innerText = "Stored from previous session";
            refreshPlaylists();
        }
        
        const volSlider = document.getElementById('vol');
        volSlider.style.setProperty('--value-percent', `${volSlider.value * 100}%`);

        setupKeyboardShortcuts();
    };

    // --- Keyboard Shortcuts ---
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ignore if user is typing in an input field
            if (e.target.tagName === 'INPUT') return;

            switch(e.code) {
                case 'Space':
                    e.preventDefault(); // Prevent scrolling
                    togglePlay();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if(audio.src) audio.currentTime += 5;
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if(audio.src) audio.currentTime -= 5;
                    break;
            }
        });
    }

    // --- Folder Logic ---
    async function restoreSession() {
        if (!musicHandle) return;
        const perm = await musicHandle.requestPermission({ mode: 'read' });
        if (perm === 'granted') {
            document.getElementById('restore-banner').style.display = 'none';
            scanMusic(musicHandle);
            switchView('library');
        }
    }

    async function pickFolder(type) {
        try {
            const handle = await window.showDirectoryPicker();
            if (type === 'music') {
                musicHandle = handle;
                await setDB('musicHandle', handle);
                document.getElementById('path-music').innerText = handle.name;
                scanMusic(handle);
            } else {
                playlistHandle = handle;
                await setDB('playlistHandle', handle);
                document.getElementById('path-playlist').innerText = handle.name;
                refreshPlaylists();
            }
        } catch(e) { console.log("Cancelled"); }
    }

    async function scanMusic(handle) {
        document.getElementById('track-list').innerHTML = '<div style="padding:50px; text-align:center">Scanning Files...</div>';
        library = [];
        
        async function traverse(dir) {
            for await (const entry of dir.values()) {
                if (entry.kind === 'file') {
                    // Support mp3, ogg, wav
                    if (/\.(mp3|ogg|wav)$/i.test(entry.name)) {
                        const type = entry.name.split('.').pop();
                        const baseName = entry.name.replace(/\.(mp3|ogg|wav)$/i, '');
                        let creator = '';
                        let songName = baseName;

                        const parts = baseName.split(' - ');
                        if (parts.length >= 2) {
                            creator = parts[0].trim();
                            songName = parts.slice(1).join(' - ').trim();
                        }
                        
                        library.push({
                            id: Math.random().toString(36).substr(2, 9),
                            name: baseName, // Keep original full name for general reference if needed
                            creator: creator,
                            songName: songName,
                            handle: entry,
                            type: type,
                            duration: '--:--'
                        });
                    }
                } else if (entry.kind === 'directory') {
                    await traverse(entry);
                }
            }
        }
        await traverse(handle);
        // Default Alphabetical Sort
        library.sort((a,b) => a.name.localeCompare(b.name));
        
        activeQueue = [...library];
        resetPlayQueue();
        
        document.getElementById('track-count').innerText = `${library.length} tracks`;
        render();

        // Post-scan processing
        for(let i=0; i<library.length; i++) {
            const track = library[i];
            document.getElementById('track-list').innerHTML = `<div style="padding:50px; text-align:center">Analyzing track ${i+1}/${library.length}...<br>${track.name}</div>`;
            track.duration = await getDuration(track.handle);
        }
        render();
    }

    function getDuration(handle) {
        return new Promise(async (resolve) => {
            const file = await handle.getFile();
            const audio = new Audio();
            audio.src = URL.createObjectURL(file);
            audio.onloadedmetadata = () => {
                URL.revokeObjectURL(audio.src);
                resolve(fmt(audio.duration));
            };
            audio.onerror = () => resolve('--:--');
        });
    }

    // --- Rendering ---
    function switchView(viewName) {
        currentView = viewName;
        
        // Navigation highlighting
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (viewName === 'library') document.getElementById('nav-library').classList.add('active');
        else if (viewName === 'settings') document.getElementById('nav-settings').classList.add('active');
        else if (viewName === 'guide') document.getElementById('nav-guide').classList.add('active');
        else {
            // Highlighting for Playlists handled in refreshPlaylists usually, simplified here
            const pItems = document.querySelectorAll('#playlist-list .nav-item');
            pItems.forEach(p => {
                if(p.innerText.includes(viewName)) p.classList.add('active');
            });
        }

        // View Toggling
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        
        if (viewName === 'settings') {
            document.getElementById('view-settings').classList.add('active');
        } else if (viewName === 'guide') {
            document.getElementById('view-guide').classList.add('active');
        } else {
            document.getElementById('view-library').classList.add('active');
            render();
        }
    }

    function render() {
        if (currentView === 'settings') return;

        const list = document.getElementById('track-list');
        list.innerHTML = '';
        const query = document.getElementById('search').value.toLowerCase();
        
        // Determine source based on view
        let source = currentView === 'library' ? library : 
            (playlists[currentView] || []).map(n => library.find(t => t.name === n)).filter(Boolean);

        // Sort the source based on sortMode
        if (sortMode === 'alphabetical') {
            source.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortMode === 'length') {
            source.sort((a, b) => (fmtToSec(a.duration) || 0) - (fmtToSec(b.duration) || 0));
        } else if (sortMode === 'format') {
            source.sort((a, b) => a.type.localeCompare(b.type));
        }

        if (sortOrder === 'desc') {
            source.reverse();
        }

        // Update activeQueue for UI context (double click logic)
        activeQueue = source;

        // Filter by search
        const filtered = source.filter(t => 
            t.songName.toLowerCase().includes(query) || 
            t.creator.toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#52525b">No tracks found</div>';
            return;
        }

        const frag = document.createDocumentFragment();
        filtered.forEach((t, i) => {
            const el = document.createElement('div');
            el.className = `track-row ${selectedIds.has(t.id) ? 'selected' : ''}`;
            if (currentTrackId === t.id) el.classList.add('playing');
            
            el.innerHTML = `
                <div style="font-size:11px; opacity:0.6">${i+1}</div>
                <div class="t-title">
                    <div>${t.songName}</div>
                    <div style="font-size:11px; color:var(--text-dim);">${t.creator}</div>
                </div>
                <div style="font-family:monospace; opacity:0.6">${t.type}</div>
                <div style="font-family:monospace; opacity:0.6">${t.duration}</div>
            `;
            
            el.onclick = (e) => {
                e.stopPropagation();
                handleRowClick(e, t.id, filtered);
            };
            el.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                if(!selectedIds.has(t.id)) { selectedIds.clear(); selectedIds.add(t.id); render(); }
                showCtx(e);
            }
            frag.appendChild(el);
        });
        list.appendChild(frag);
    }

    function handleRowClick(e, id, contextList) {
        if (e.metaKey || e.ctrlKey) {
            selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id);
        } else if (e.shiftKey && selectedIds.size > 0) {
            const allIds = contextList.map(t => t.id);
            const start = allIds.indexOf([...selectedIds][0]);
            const end = allIds.indexOf(id);
            const [min, max] = [Math.min(start, end), Math.max(start, end)];
            for (let i=min; i<=max; i++) selectedIds.add(allIds[i]);
        } else {
            selectedIds.clear();
            selectedIds.add(id);
            if (e.detail === 2) { // Double click
                // When double clicking, we set the Play Queue to the current view list
                resetPlayQueue(contextList); 
                playById(id);
            }
        }
        render();
    }

    // --- Audio Logic ---
    async function playById(id) {
        const track = library.find(t => t.id === id);
        if(!track) return;

        currentTrackId = id;
        const file = await track.handle.getFile();
        audio.src = URL.createObjectURL(file);
        audio.play();

        document.getElementById('np-title').innerText = track.songName;
        document.getElementById('np-artist').innerText = track.creator;
        document.getElementById('play-icon').innerText = 'Pause';
        render();
    }

    function togglePlay() { 
        if(!audio.src) return;
        audio.paused ? (audio.play(), document.getElementById('play-icon').innerText='Pause') : (audio.pause(), document.getElementById('play-icon').innerText='Play'); 
    }

    // --- Shuffle & Queue Logic ---
    function toggleShuffle() {
        isShuffled = !isShuffled;
        document.getElementById('btn-shuffle').classList.toggle('active', isShuffled);
        
        if (isShuffled) {
            // Shuffle the playQueue
            playQueue = playQueue.sort(() => Math.random() - 0.5);
        } else {
            // Restore alphabetical/playlist order logic
            // (Simple version: just re-sort playQueue by name or re-fetch from active view)
            playQueue.sort((a,b) => a.name.localeCompare(b.name));
        }
    }

    function resetPlayQueue(specificList = null) {
        // Sets the internal playback queue based on current view or specific list
        let source = specificList ? specificList : activeQueue;
        playQueue = [...source];
        if (isShuffled) playQueue.sort(() => Math.random() - 0.5);
    }

    function next() {
        if(!playQueue.length) return;
        const currentIdx = playQueue.findIndex(t => t.id === currentTrackId);
        const nextIdx = (currentIdx + 1) % playQueue.length;
        playById(playQueue[nextIdx].id);
    }

    function prev() {
        if(!playQueue.length) return;
        const currentIdx = playQueue.findIndex(t => t.id === currentTrackId);
        const prevIdx = (currentIdx - 1 + playQueue.length) % playQueue.length;
        playById(playQueue[prevIdx].id);
    }

    audio.onended = next; // Auto play next

    audio.ontimeupdate = () => {
        const pct = (audio.currentTime / audio.duration) * 100 || 0;
        const seek = document.getElementById('seek');
        seek.value = pct;
        seek.style.setProperty('--value-percent', `${pct}%`);
        document.getElementById('t-cur').innerText = fmt(audio.currentTime);
        document.getElementById('t-dur').innerText = fmt(audio.duration);
    }
    document.getElementById('seek').oninput = (e) => {
        audio.currentTime = (e.target.value/100)*audio.duration;
        e.target.style.setProperty('--value-percent', `${e.target.value}%`);
    };
    document.getElementById('vol').oninput = (e) => {
        audio.volume = e.target.value;
        e.target.style.setProperty('--value-percent', `${e.target.value * 100}%`);
    };

    // --- Playlists & Utils ---
    async function refreshPlaylists() {
        if (!playlistHandle) return;
        const container = document.getElementById('playlist-list');
        container.innerHTML = '';
        playlists = {};
        
        for await (const entry of playlistHandle.values()) {
            if (entry.name.endsWith('.json')) {
                const name = entry.name.replace('.json', '');
                const file = await entry.getFile();
                try {
                    playlists[name] = JSON.parse(await file.text());
                } catch(e) { playlists[name] = []; }
                
                const div = document.createElement('div');
                div.className = `nav-item ${currentView === name ? 'active' : ''}`;
                div.innerHTML = `<span onclick="switchView('${name}')">${name}</span> <i class="trash-btn" onclick="deletePlaylist('${entry.name}')">Delete</i>`;
                container.appendChild(div);
            }
        }
    }

    async function createPlaylist() {
        const name = document.getElementById('new-p-name').value;
        if(name && playlistHandle) {
            const h = await playlistHandle.getFileHandle(`${name}.json`, {create:true});
            const w = await h.createWritable(); await w.write("[]"); await w.close();
            closeModals(); refreshPlaylists();
        } else if (!playlistHandle) {
            alert("Please select a Playlist Folder in Settings first.");
        }
    }
    
    async function addToPlaylist(name) {
        const h = await playlistHandle.getFileHandle(`${name}.json`);
        const file = await h.getFile();
        let list = JSON.parse(await file.text());
        selectedIds.forEach(id => {
            const t = library.find(x => x.id === id);
            if(t && !list.includes(t.name)) list.push(t.name);
        });
        const w = await h.createWritable(); await w.write(JSON.stringify(list)); await w.close();
        closeModals();
    }
    
    async function deletePlaylist(fname) {
        if(confirm('Delete playlist?')) { await playlistHandle.removeEntry(fname); refreshPlaylists(); }
    }

    function handleGlobalClick(e) {
        if (e.target.closest('.track-row') || e.target.closest('#ctx-menu') || e.target.closest('.modal') || e.target.closest('.view-options')) return;
        if (selectedIds.size > 0) { selectedIds.clear(); render(); }
        document.getElementById('ctx-menu').style.display = 'none';
        document.getElementById('view-menu').style.display = 'none';
    }

    function toggleSortMenu() {
        const menu = document.getElementById('view-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function setSortMode(mode) {
        sortMode = mode;
        document.querySelectorAll('.view-item').forEach(item => {
            item.classList.toggle('active', item.dataset.mode === mode);
        });
        render();
        toggleSortMenu();
    }

    function toggleSortOrder() {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        render();
        toggleSortMenu();
    }
    
    function showCtx(e) {
        const m = document.getElementById('ctx-menu');
        m.style.display = 'block'; m.style.left = e.pageX + 'px'; m.style.top = e.pageY + 'px';
    }
    
    function playSelected() {
        const id = [...selectedIds][0];
        resetPlayQueue(); 
        playById(id);
        document.getElementById('ctx-menu').style.display = 'none';
    }

    function openAddToModal() {
        if(!playlistHandle) { alert("Please set a Playlist Folder in Settings first."); return; }
        const list = document.getElementById('target-list'); list.innerHTML = '';
        Object.keys(playlists).forEach(name => {
            const d = document.createElement('div'); d.className='nav-item'; d.innerText=name;
            d.onclick=()=>addToPlaylist(name); list.appendChild(d);
        });
        openModal('add-to-modal');
    }

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }
    function fmt(s) { const m=Math.floor(s/60), ss=Math.floor(s%60); return isNaN(s)?'0:00':`${m}:${ss<10?'0':''}${ss}`; }
    function fmtToSec(t) { if (!t || t === '--:--') return 0; const p = t.split(':').map(Number); return p[0] * 60 + p[1]; }
    
    // IDB
    function idb() { return new Promise(r => { const q = indexedDB.open('MusicProV5', 1); q.onupgradeneeded=()=>q.result.createObjectStore('s'); q.onsuccess=()=>r(q.result); }); }
    async function setDB(k,v) { const db = await idb(); db.transaction('s','readwrite').objectStore('s').put(v,k); }
    async function getDB(k) { const db = await idb(); return new Promise(r => { const q = db.transaction('s').objectStore('s').get(k); q.onsuccess=()=>r(q.result); }); }

</script>
</body>
</html>